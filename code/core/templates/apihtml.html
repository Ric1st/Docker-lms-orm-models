<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard API Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container mt-5">
        <h1>Test API dengan Throttling</h1>
        <div class="alert alert-info">
            <strong>Info Throttling:</strong> Maksimal 10 requests per menit
        </div>

        <!-- USERS TABLE -->
        <div class="card shadow mb-5">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Daftar User</h4>
                <span id="userCount" class="badge bg-light text-dark"></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Nama Depan</th>
                                <th>Nama Belakang</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="userPagination"></ul>
                </nav>
            </div>
        </div>

        <!-- COURSES TABLE -->
        <div class="card shadow mb-5">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Daftar Kursus</h4>
                <span id="courseCount" class="badge bg-light text-dark"></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Nama</th>
                                <th>Deskripsi</th>
                                <th>Harga</th>
                                <th>Teacher ID</th>
                            </tr>
                        </thead>
                        <tbody id="courseTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="coursePagination"></ul>
                </nav>
            </div>
        </div>

        <!-- MEMBERS TABLE -->
        <div class="card shadow mb-5">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Daftar Member</h4>
                <span id="memberCount" class="badge bg-light text-dark"></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>User ID</th>
                                <th>Course ID</th>
                                <th>Roles</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="memberPagination"></ul>
                </nav>
            </div>
        </div>

        <!-- CONTENTS TABLE -->
        <div class="card shadow mb-5">
            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Daftar Konten Kursus</h4>
                <span id="contentCount" class="badge bg-light text-dark"></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Course ID</th>
                                <th>Nama</th>
                                <th>Deskripsi</th>
                                <th>Video URL</th>
                                <th>Attachment</th>
                            </tr>
                        </thead>
                        <tbody id="contentTableBody">
                            <tr>
                                <td colspan="6" class="text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="contentPagination"></ul>
                </nav>
            </div>
        </div>

        <!-- COMMENTS TABLE -->
        <div class="card shadow mb-5">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Komentar</h4>
                <span id="commentCount" class="badge bg-light text-dark"></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Content ID</th>
                                <th>Member ID</th>
                                <th>Komentar</th>
                            </tr>
                        </thead>
                        <tbody id="commentTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="commentPagination"></ul>
                </nav>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const ITEMS_PER_PAGE = 5;

        // Generic pagination function
        function paginate(data, page = 1) {
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            return {
                data: data.slice(start, end),
                totalPages: Math.ceil(data.length / ITEMS_PER_PAGE),
                currentPage: page,
                total: data.length
            };
        }

        // Generic pagination UI
        function renderPagination(containerId, currentPage, totalPages, onPageChange) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
            prevLi.onclick = (e) => {
                e.preventDefault();
                if (currentPage > 1) onPageChange(currentPage - 1);
            };
            container.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = (e) => {
                    e.preventDefault();
                    onPageChange(i);
                };
                container.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
            nextLi.onclick = (e) => {
                e.preventDefault();
                if (currentPage < totalPages) onPageChange(currentPage + 1);
            };
            container.appendChild(nextLi);
        }

        // USERS
        let usersData = [];
        let usersCurrentPage = 1;

        async function loadUsers(page = 1) {
            try {
                if (usersData.length === 0) {
                    const res = await fetch("/api/v1/users");

                    // Check for throttling
                    if (res.status === 429) {
                        const errorData = await res.json();
                        const body = document.getElementById("userTableBody");
                        body.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center text-warning">
                                    <i class="bi bi-exclamation-triangle-fill fs-2"></i><br>
                                    <strong>TOO MANY REQUESTS!</strong><br>
                                    <small>${errorData.detail || 'Throttling limit exceeded. Please wait a moment and try again.'}</small>
                                </td>
                            </tr>`;
                        document.getElementById("userCount").textContent = 'Throttled';
                        return;
                    }

                    if (!res.ok) {
                        throw new Error(`HTTP Error: ${res.status}`);
                    }

                    const data = await res.json();
                    usersData = (data.items || data).sort((a, b) => a.id - b.id);
                }

                const paginated = paginate(usersData, page);
                usersCurrentPage = page;

                const body = document.getElementById("userTableBody");
                body.innerHTML = "";

                paginated.data.forEach(u => {
                    body.insertAdjacentHTML("beforeend", `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.username}</td>
                            <td>${u.first_name || '-'}</td>
                            <td>${u.last_name || '-'}</td>
                            <td>${u.email}</td>
                        </tr>
                    `);
                });

                document.getElementById("userCount").textContent = `Total: ${paginated.total}`;
                renderPagination('userPagination', paginated.currentPage, paginated.totalPages, loadUsers);
            } catch (error) {
                document.getElementById("userTableBody").innerHTML =
                    `<tr><td colspan="5" class="text-center text-danger">
                        <i class="bi bi-x-circle-fill fs-2"></i><br>
                        Error: ${error.message}
                    </td></tr>`;
            }
        }

        // COURSES
        let coursesData = [];
        let coursesCurrentPage = 1;

        async function loadCourses(page = 1) {
            try {
                if (coursesData.length === 0) {
                    const res = await fetch("/api/v1/courses-public/");

                    // Check for throttling
                    if (res.status === 429) {
                        const errorData = await res.json();
                        const body = document.getElementById("courseTableBody");
                        body.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center text-warning">
                                    <i class="bi bi-exclamation-triangle-fill fs-2"></i><br>
                                    <strong>TOO MANY REQUESTS!</strong><br>
                                    <small>${errorData.detail || 'Throttling limit exceeded. Please wait a moment and try again.'}</small>
                                </td>
                            </tr>`;
                        document.getElementById("courseCount").textContent = 'Throttled';
                        return;
                    }

                    if (!res.ok) {
                        throw new Error(`HTTP Error: ${res.status}`);
                    }

                    const data = await res.json();
                    coursesData = data;
                }

                const paginated = paginate(coursesData, page);
                coursesCurrentPage = page;

                const body = document.getElementById("courseTableBody");
                body.innerHTML = "";

                paginated.data.forEach(c => {
                    body.insertAdjacentHTML("beforeend", `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.name}</td>
                            <td>${c.description}</td>
                            <td>Rp ${c.price.toLocaleString('id-ID')}</td>
                            <td>${c.teacher || '-'}</td>
                        </tr>
                    `);
                });

                document.getElementById("courseCount").textContent = `Total: ${paginated.total}`;
                renderPagination('coursePagination', paginated.currentPage, paginated.totalPages, loadCourses);
            } catch (error) {
                document.getElementById("courseTableBody").innerHTML =
                    `<tr><td colspan="5" class="text-center text-danger">
                        <i class="bi bi-x-circle-fill fs-2"></i><br>
                        Error: ${error.message}
                    </td></tr>`;
            }
        }

        // MEMBERS
        let membersData = [];
        let membersCurrentPage = 1;

        async function loadMembers(page = 1) {
            try {
                if (membersData.length === 0) {
                    const res = await fetch("/api/v1/members");

                    // Check for throttling
                    if (res.status === 429) {
                        const errorData = await res.json();
                        const body = document.getElementById("memberTableBody");
                        body.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center text-warning">
                                    <i class="bi bi-exclamation-triangle-fill fs-2"></i><br>
                                    <strong>TOO MANY REQUESTS!</strong><br>
                                    <small>${errorData.detail || 'Throttling limit exceeded. Please wait a moment and try again.'}</small>
                                </td>
                            </tr>`;
                        document.getElementById("memberCount").textContent = 'Throttled';
                        return;
                    }

                    if (!res.ok) {
                        throw new Error(`HTTP Error: ${res.status}`);
                    }

                    const data = await res.json();
                    membersData = data;
                }

                const paginated = paginate(membersData, page);
                membersCurrentPage = page;

                const body = document.getElementById("memberTableBody");
                body.innerHTML = "";

                paginated.data.forEach(m => {
                    body.insertAdjacentHTML("beforeend", `
                        <tr>
                            <td>${m.id}</td>
                            <td>${m.user_id}</td>
                            <td>${m.course_id}</td>
                            <td><span class="badge bg-primary">${m.roles}</span></td>
                        </tr>
                    `);
                });

                document.getElementById("memberCount").textContent = `Total: ${paginated.total}`;
                renderPagination('memberPagination', paginated.currentPage, paginated.totalPages, loadMembers);
            } catch (error) {
                document.getElementById("memberTableBody").innerHTML =
                    `<tr><td colspan="4" class="text-center text-danger">
                        <i class="bi bi-x-circle-fill fs-2"></i><br>
                        Error: ${error.message}
                    </td></tr>`;
            }
        }

        // CONTENTS
        let contentsData = [];
        let contentsCurrentPage = 1;

        async function loadContents(page = 1) {
            try {
                if (contentsData.length === 0) {
                    const res = await fetch("/api/v1/contents");

                    // Check for throttling
                    if (res.status === 429) {
                        const errorData = await res.json();
                        const body = document.getElementById("contentTableBody");
                        body.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-warning">
                                    <i class="bi bi-exclamation-triangle-fill fs-2"></i><br>
                                    <strong>TOO MANY REQUESTS!</strong><br>
                                    <small>${errorData.detail || 'Throttling limit exceeded. Please wait a moment and try again.'}</small>
                                </td>
                            </tr>`;
                        document.getElementById("contentCount").textContent = 'Throttled';
                        return;
                    }

                    if (!res.ok) {
                        throw new Error(`HTTP Error: ${res.status}`);
                    }

                    const data = await res.json();
                    contentsData = data;
                }

                const paginated = paginate(contentsData, page);
                contentsCurrentPage = page;

                const body = document.getElementById("contentTableBody");
                body.innerHTML = "";

                paginated.data.forEach(c => {
                    body.insertAdjacentHTML("beforeend", `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.course_id}</td>
                            <td>${c.name}</td>
                            <td>${c.description}</td>
                            <td>${c.video_url ? `<a href="${c.video_url}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="bi bi-play-circle"></i> Link
                            </a>` : '-'}</td>
                            <td>${c.file_attachment ?? "-"}</td>
                        </tr>
                    `);
                });

                document.getElementById("contentCount").textContent = `Total: ${paginated.total}`;
                renderPagination('contentPagination', paginated.currentPage, paginated.totalPages, loadContents);
            } catch (error) {
                document.getElementById("contentTableBody").innerHTML =
                    `<tr><td colspan="6" class="text-center text-danger">
                        <i class="bi bi-x-circle-fill fs-2"></i><br>
                        Error: ${error.message}
                    </td></tr>`;
            }
        }

        // COMMENTS
        let commentsData = [];
        let commentsCurrentPage = 1;

        async function loadComments(page = 1) {
            try {
                if (commentsData.length === 0) {
                    const res = await fetch("/api/v1/comments");

                    // Check for throttling
                    if (res.status === 429) {
                        const errorData = await res.json();
                        const body = document.getElementById("commentTableBody");
                        body.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center text-warning">
                                    <i class="bi bi-exclamation-triangle-fill fs-2"></i><br>
                                    <strong>TOO MANY REQUESTS!</strong><br>
                                    <small>${errorData.detail || 'Throttling limit exceeded. Please wait a moment and try again.'}</small>
                                </td>
                            </tr>`;
                        document.getElementById("commentCount").textContent = 'Throttled';
                        return;
                    }

                    if (!res.ok) {
                        throw new Error(`HTTP Error: ${res.status}`);
                    }

                    const data = await res.json();
                    commentsData = data;
                }

                const paginated = paginate(commentsData, page);
                commentsCurrentPage = page;

                const body = document.getElementById("commentTableBody");
                body.innerHTML = "";

                paginated.data.forEach(c => {
                    body.insertAdjacentHTML("beforeend", `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.content_id}</td>
                            <td>${c.member_id}</td>
                            <td>${c.comment}</td>
                        </tr>
                    `);
                });

                document.getElementById("commentCount").textContent = `Total: ${paginated.total}`;
                renderPagination('commentPagination', paginated.currentPage, paginated.totalPages, loadComments);
            } catch (error) {
                document.getElementById("commentTableBody").innerHTML =
                    `<tr><td colspan="4" class="text-center text-danger">
                        <i class="bi bi-x-circle-fill fs-2"></i><br>
                        Error: ${error.message}
                    </td></tr>`;
            }
        }

        // Load all data
        loadUsers();
        loadCourses();
        loadMembers();
        loadContents();
        loadComments();
    </script>

</body>

</html>